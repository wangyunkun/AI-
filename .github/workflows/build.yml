name: Build Flet App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 允许在 GitHub 网页手动点击运行

jobs:
  # 任务一：打包 Windows exe (使用 PyInstaller)
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # 建议使用 3.10 或以上

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build EXE
        # 如果你有图标，请把 main.py 改为 --icon=assets/icon.ico main.py (需自行上传图标)
        run: |
          pyinstaller --name myapp --onefile --noconsole main.py

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: dist/*.exe

  # 任务二：打包 Android APK (使用 flet build apk)
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # Android 构建通常需要 Java 17

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0' # 指定一个稳定的 Flutter 版本
          channel: 'stable'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Flet and Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet
          # 这一步是为了验证依赖能否安装，实际上 flet build 会再次处理依赖
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build APK
        # 这一步会自动下载 Android SDK 和相关工具
        run: |
          flet build apk --verbose

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          # Flet 构建后的 APK 通常在这个路径
          path: build/app/outputs/flutter-apk/app-release.apk
