name: Build Flet App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================
  # 任务一：打包 Windows EXE (电脑版)
  # ============================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet pyinstaller pillow

      - name: Build EXE
        # Windows 文件名 (建议用英文，APP打开后的标题栏是中文)
        run: |
          flet pack main.py --name SafetyCheckAI --verbose

      - name: Upload Windows Exe
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: dist/*.exe

  # ============================================
  # 任务二：打包 Android APK (手机版)
  # ============================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install flet
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ===========================================================
      # 【核心修复】使用 Python 生成配置文件
      # 相比用 echo 命令，Python 能完美处理中文编码，确保 APP 名称生效
      # ===========================================================
      - name: Generate Config with Python
        run: |
          python -c "
          import os
          config_content = '''[tool.flet]
          product_name = \"安全检查AI\"
          org = \"com.safety.ai\"
          product_description = \"施工安全隐患排查工具\"
          android_permissions = [\"WRITE_EXTERNAL_STORAGE\", \"READ_EXTERNAL_STORAGE\"]
          '''
          with open('pyproject.toml', 'w', encoding='utf-8') as f:
              f.write(config_content)
          print('✅ 配置文件生成成功，内容如下：')
          print(config_content)
          "

      - name: Build APK
        # 使用当前目录 (.) 确保它读取刚才生成的 pyproject.toml
        run: |
          flet build apk . --verbose

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-app
          path: "**/*.apk"
